<Project>
  <PropertyGroup>
    <!-- Used by analyzers via build_property.* to detect that rewriting is enabled. -->
    <OdinDesignContractsRewriterEnabled>true</OdinDesignContractsRewriterEnabled>

    <!-- Allow consumers to disable weaving explicitly. -->
    <OdinDesignContractsWeaveEnabled Condition="'$(OdinDesignContractsWeaveEnabled)'==''">true</OdinDesignContractsWeaveEnabled>
  </PropertyGroup>

  <Target Name="OdinDesignContracts_Weaving"
          AfterTargets="CoreCompile"
          Inputs="$(IntermediateOutputPath)$(TargetFileName)"
          Outputs="$(IntermediateOutputPath)$(TargetName).odin-design-contracts-weaved.dll"
          Condition="'$(OdinDesignContractsWeaveEnabled)'=='true' and '$(TargetPath)'!=''">

    <PropertyGroup>
      <_OdinNetVersion>$(TargetFramework.Substring(3))</_OdinNetVersion>
      <_OdinDcRewriterPathCandidate>$(MSBuildThisFileDirectory)..\tools\net$(_OdinNetVersion)\any\Odin.DesignContracts.Rewriter.dll</_OdinDcRewriterPathCandidate>
      <_OdinDcRewriterPath Condition="Exists('$(_OdinDcRewriterPathCandidate)')">$(_OdinDcRewriterPathCandidate)</_OdinDcRewriterPath>
      <_OdinDcRewriterPath Condition="'$(_OdinDcRewriterPath)'==''">$(MSBuildThisFileDirectory)..\tools\net10.0\any\Odin.DesignContracts.Rewriter.dll</_OdinDcRewriterPath>
      <_OdinDcWeavedAssembly>$(IntermediateOutputPath)$(AssemblyName).odin-design-contracts-weaved$(TargetExt)</_OdinDcWeavedAssembly>
      <_OdinDcWeavedPdb>$(IntermediateOutputPath)$(AssemblyName).odin-design-contracts-weaved.pdb</_OdinDcWeavedPdb>
    </PropertyGroup>

    <Message Importance="High" Text="Odin DesignContracts: Weaving invariants and postconditions into $(TargetPath)" />
    <Message Importance="High" Text="MSBuildThisFileDirectory: &quot;$(MSBuildThisFileDirectory)&quot;" />
    <Message Importance="High" Text="AssemblyName: &quot;$(AssemblyName)&quot;" />
    <Message Importance="High" Text="TargetName: &quot;$(TargetName)&quot;" />
    <Message Importance="High" Text="TargetFileName: &quot;$(TargetFileName)&quot;" />
    <Message Importance="High" Text="TargetPath: &quot;$(TargetPath)&quot;" />
    <Message Importance="High" Text="IntermediateOutputPath: &quot;$(IntermediateOutputPath)&quot;" />
    <Message Importance="High" Text="InputFile (IntermediateOutputPath+TargetFileName): &quot;$(IntermediateOutputPath)$(TargetFileName)&quot;" />
    <Message Importance="High" Text="_OdinDcRewriterPath: &quot;$(_OdinDcRewriterPath)&quot;" />
    <Message Importance="High" Text="_OdinDcWeavedAssembly: &quot;$(_OdinDcWeavedAssembly)&quot;" />

    <Exec Command="dotnet &quot;$(_OdinDcRewriterPath)&quot; &quot;$(IntermediateOutputPath)$(TargetFileName)&quot; &quot;$(_OdinDcWeavedAssembly)&quot;" />

    <!-- Replace the compiled assembly with the weaved one -->
    <Copy SourceFiles="$(_OdinDcWeavedAssembly)" DestinationFiles="$(TargetPath)" OverwriteReadOnlyFiles="true" />

    <!-- Replace PDB if present -->
    <Copy SourceFiles="$(_OdinDcWeavedPdb)" DestinationFiles="$(TargetDir)$(TargetName).pdb" OverwriteReadOnlyFiles="true"
          Condition="Exists('$(_OdinDcWeavedPdb)') and '$(DebugSymbols)'=='true'" />
  </Target>
</Project>
